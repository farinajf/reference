<?xml version="1.0" encoding="UTF-8"?>
<sequence name="AmtegaGenericFaultSequence" statistics="enable" trace="enable" xmlns="http://ws.apache.org/ns/synapse">
    <log category="ERROR" level="custom">
        <property name="text" value="LOG-ERROR:"/>
        <property expression="$ctx:AmtegaMessageID" name="AmtegaMessageID"/>
        <property expression="$axis2:HTTP_SC" name="HTTP_SC"/>
        <property expression="$ctx:ERROR_CODE" name="ERROR_CODE"/>
        <property expression="$ctx:ERROR_MESSAGE" name="ERROR_MESSAGE"/>
        <property expression="$ctx:ERROR_DETAIL" name="ERROR_DETAIL"/>
        <property expression="$ctx:ERROR_EXCEPTION" name="ERROR_EXCEPTION"/>
        <property expression="$ctx:proxy.name" name="PROXY"/>
        <property expression="$ctx:ENDPOINT_PREFIX" name="ENDPOINT"/>
    </log>
    <!--  +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    +                     Si hemos recibido un FAULT se encadena                          +
    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->
    <filter description="HTTP 500" regex="[5]\d{2}$" source="$axis2:HTTP_SC">
        <then>
            <filter description="SOAP12" xmlns:soapenv12="http://www.w3.org/2003/05/soap-envelope" xpath="//soapenv12:Fault/soapenv12:Reason">
                <then>
                    <property expression="fn:concat('{Reason:',//soapenv12:Fault/soapenv12:Reason,' Detail:',//soapenv12:Fault/soapenv12:Detail,'}')" name="AMTEGA_FAULT_RECEIVED" scope="default" type="STRING"/>
                </then>
                <else>
                    <filter description="SOAP11" xmlns:soapenv11="http://schemas.xmlsoap.org/soap/envelope/" xpath="//soapenv11:Fault/faultstring">
                        <then>
                            <property expression="fn:concat('{Reason:',//soapenv11:Fault/faultstring,' Detail:',//soapenv11:Fault/detail,'}')" name="AMTEGA_FAULT_RECEIVED" scope="default" type="STRING"/>
                        </then>
                        <else/>
                    </filter>
                </else>
            </filter>
        </then>
        <else/>
    </filter>
    <property expression="fn:concat($ctx:ERROR_MESSAGE, ' [To:', $ctx:ENDPOINT_PREFIX, '] ', $ctx:AMTEGA_FAULT_RECEIVED)" name="AMTEGA_FAULT_DETAIL" scope="default" type="STRING"/>
    <!--  +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    +                    Se construye el mensaje de FAULT                                 +
    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->
    <filter description="SOAP11" regex="true" source="$ctx:IsClientDoingSOAP11">
        <then>
            <makefault description="SOAP11" version="soap11">
                <code value="soap11Env:Server" xmlns:soap11Env="http://schemas.xmlsoap.org/soap/envelope/"/>
                <reason expression="$ctx:ERROR_CODE"/>
                <detail expression="$ctx:AMTEGA_FAULT_DETAIL"/>
            </makefault>
        </then>
        <else>
            <filter description="REST" regex="true" source="$ctx:IsClientDoingREST">
                <then>
                    <makefault description="REST" version="pox">
                        <reason expression="$ctx:ERROR_CODE"/>
                        <detail expression="$ctx:AMTEGA_FAULT_DETAIL"/>
                    </makefault>
                </then>
                <else>
                    <makefault description="SOAP12" version="soap12">
                        <code value="soap12Env:VersionMismatch" xmlns:soap12Env="http://www.w3.org/2003/05/soap-envelope"/>
                        <reason expression="$ctx:ERROR_CODE"/>
                        <detail expression="$ctx:AMTEGA_FAULT_DETAIL"/>
                    </makefault>
                </else>
            </filter>
        </else>
    </filter>
    <header action="remove" name="To" scope="default"/>
    <property name="RESPONSE" scope="default" type="STRING" value="true"/>
    <!--  +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    +                Si existe AmtegaMessageID se establece como HTTP Header              +
    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->
    <filter description="Si existe AmtegaMessageID se establece como HTTP Header" xpath="$ctx:AmtegaMessageID">
        <then>
            <property expression="$ctx:AmtegaMessageID" name="AmtegaMessageID" scope="transport" type="STRING"/>
        </then>
        <else/>
    </filter>
    <send/>
</sequence>
